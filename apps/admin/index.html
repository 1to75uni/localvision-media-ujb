<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LocalVision Admin (V3)</title>
  <style>
    :root { --bg:#0b0f17; --panel:#0f1624; --card:#121c2e; --text:#e8eefc; --muted:#94a3b8; --accent:#3b82f6; --danger:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    header h1{font-size:16px;margin:0;font-weight:700}
    header .meta{font-size:12px;color:var(--muted)}
    main{display:grid;grid-template-columns:360px 1fr;min-height:calc(100vh - 54px)}
    aside{border-right:1px solid rgba(255,255,255,.08);padding:14px;background:var(--panel)}
    section{padding:14px}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px 0}
    input[type="text"]{width:100%;padding:10px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--text);outline:none}
    input[type="checkbox"]{transform:scale(1.1)}
    button{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:#0b1220;color:var(--text);cursor:pointer}
    button.primary{background:var(--accent);border-color:transparent;color:white;font-weight:700}
    button.danger{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fecaca}
    button.small{padding:7px 10px;font-size:12px;border-radius:9px}
    .list{display:flex;flex-direction:column;gap:8px}
    .item{padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);background:#0b1220;cursor:pointer}
    .item.active{outline:2px solid rgba(59,130,246,.5)}
    .item .name{font-weight:700}
    .item .id{font-size:12px;color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:10px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .muted{color:var(--muted);font-size:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:#0b1220;font-size:12px;color:var(--muted)}
    .status-dot{width:8px;height:8px;border-radius:50%;background:#64748b}
    .status-dot.online{background:#22c55e}
    .status-dot.offline{background:#ef4444}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:13px;vertical-align:middle}
    .table th{text-align:left;color:var(--muted);font-weight:600}
    .right{display:flex;justify-content:flex-end}
    dialog{border:none;border-radius:16px;background:#0b1220;color:var(--text);padding:12px;max-width:520px;width:calc(100vw - 28px)}
    dialog::backdrop{background:rgba(0,0,0,.55)}
    #qrCanvas{width:280px;height:280px;background:white;border-radius:12px}
    .hint{font-size:12px;color:var(--muted);line-height:1.5}
    .nowrap{white-space:nowrap}
    .targetsInput{width:100%;min-width:140px}
    .miniLink{font-size:12px;color:#93c5fd;text-decoration:none}
  </style>
</head>
<body>
  <header>
    <h1>LocalVision Admin (V3)</h1>
    <span class="meta">업체 생성 → Left 업로드 → Player URL/QR → 상태 확인 + 공통 Right(타겟/전체패널) 관리</span>
    <span style="flex:1"></span>
    <span class="pill"><span class="status-dot" id="apiDot"></span><span class="mono" id="apiBaseLabel">API: -</span></span>
  </header>

  <main>
    <aside>
      <div class="card">
        <label>API Base (Worker URL)</label>
        <div class="row">
          <input id="apiBaseInput" type="text" placeholder="https://...workers.dev" />
        </div>
        <div class="row" style="margin-top:8px">
          <button class="primary" id="saveApiBtn">저장</button>
          <button id="testApiBtn">테스트</button>
        </div>
        <div class="hint" style="margin-top:8px">
          • Admin/Player URL에 <b>apiBase</b>가 자동 포함되게 저장됩니다.<br/>
          • 저장 후 새로고침해도 유지됩니다.
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div style="flex:1">
            <div style="font-weight:800;margin-bottom:4px">업체 목록</div>
            <div class="muted">왼쪽에서 업체 선택</div>
          </div>
          <button class="small" id="refreshStoresBtn">새로고침</button>
        </div>
        <div class="hr"></div>
        <div class="list" id="storesList"></div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:8px">업체 만들기</div>
        <div class="grid2">
          <div>
            <label>업체명</label>
            <input id="newName" type="text" placeholder="예: 곱네" />
          </div>
          <div>
            <label>storeId(영문)</label>
            <input id="newId" type="text" placeholder="예: goobne" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <button class="primary" id="createStoreBtn">업체 만들기</button>
        </div>
        <div class="hint" style="margin-top:8px">※ storeId는 소문자 영문/숫자만 추천</div>
      </div>

      <div class="card">
        <div style="font-weight:800;margin-bottom:6px">공통 Right 콘텐츠</div>
        <div class="muted">stores/_common/right (모든 TV 공유)</div>
        <div class="hr"></div>

        <div class="row">
          <input id="rightUpload" type="file" accept="image/*,video/mp4" />
          <button class="primary small" id="rightUploadBtn">업로드</button>
          <button class="small" id="rightRefreshBtn">새로고침</button>
        </div>

        <div style="margin-top:10px">
          <table class="table">
            <thead>
              <tr>
                <th>파일</th>
                <th class="nowrap">targets</th>
                <th class="nowrap">전체패널</th>
                <th class="nowrap">저장</th>
                <th class="right nowrap">삭제</th>
              </tr>
            </thead>
            <tbody id="rightList"><tr><td colspan="5" class="muted">불러오는 중…</td></tr></tbody>
          </table>
        </div>

        <div class="hint" style="margin-top:10px">
          • <b>targets</b>: 비우면 전체 노출, 입력하면 해당 store만 노출 (예: <span class="mono">goobne,sbflower</span>)<br/>
          • <b>전체패널</b>: 체크하면 right 아이템이 좌/우를 덮는 전체화면으로 잠깐 재생됩니다.<br/>
          • 업로드하면 자동으로 <b>right_1, right_2…</b> 슬롯 + <b>playlist.json</b> 생성
        </div>
      </div>
    </aside>

    <section>
      <div class="card" id="storeDetailCard">
        <div style="font-weight:900;margin-bottom:8px">업체 상세</div>
        <div class="muted" id="storeHint">왼쪽에서 업체를 선택하세요.</div>
      </div>

      <div class="card" id="leftCard" style="display:none">
        <div class="row">
          <div style="flex:1">
            <div style="font-weight:900;margin-bottom:4px">Left 콘텐츠</div>
            <div class="muted">업로드하면 자동으로 left_1, left_2… 슬롯이 붙어요.</div>
          </div>
          <button class="small" id="leftRefreshBtn">새로고침</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <input id="leftUpload" type="file" accept="image/*,video/mp4" />
          <button class="primary" id="leftUploadBtn">업로드</button>
        </div>

        <div style="margin-top:10px">
          <table class="table">
            <thead><tr><th>파일</th><th class="right">삭제</th></tr></thead>
            <tbody id="leftList"><tr><td colspan="2" class="muted">불러오는 중…</td></tr></tbody>
          </table>
        </div>
      </div>

      <div class="card" id="statusCard" style="display:none">
        <div class="row">
          <div style="flex:1">
            <div style="font-weight:900;margin-bottom:4px">TV 상태</div>
            <div class="muted">Heartbeat 기준 (TTL: 120초)</div>
          </div>
          <button class="small" id="statusRefreshBtn">상태 새로고침</button>
        </div>
        <div class="hr"></div>
        <div class="row">
          <span class="pill"><span class="status-dot" id="tvDot"></span><span id="tvStatus">UNKNOWN</span></span>
          <span class="pill">마지막 신호: <span class="mono" id="tvLastSeen">-</span></span>
        </div>
      </div>

      <div class="card" id="linksCard" style="display:none">
        <div class="row">
          <div style="flex:1">
            <div style="font-weight:900;margin-bottom:4px">링크</div>
            <div class="muted">TV용 Player URL / QR</div>
          </div>
          <button class="small" id="copyUrlBtn">플레이어 URL 복사</button>
          <button class="small" id="showQrBtn">QR 보기</button>
        </div>
        <div class="hr"></div>

        <div class="muted">TV용 Player URL</div>
        <div class="mono" id="playerUrl" style="margin-top:6px;word-break:break-all"></div>

        <div class="hint" style="margin-top:10px">
          • 이 URL에는 <b>apiBase</b>가 항상 포함됩니다.<br/>
          • Player 기본 새로고침은 <b>07:00</b> 입니다. (?restart=09:30 같은 오버라이드 가능)
        </div>
      </div>
    </section>
  </main>

  <dialog id="qrDialog">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:900">Player QR</div>
      <button class="small" id="closeQrBtn">닫기</button>
    </div>
    <div class="hr"></div>
    <canvas id="qrCanvas" width="280" height="280"></canvas>
    <div class="hint" style="margin-top:10px">
      TV에서 QR 스캔 → Start URL 등록 (Fully Kiosk 권장)
    </div>
  </dialog>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <script src="./app.js"></script>
</body>
</html>
